import json
import sqlite3
from db import get_user
from aiogram import types

def load_brainrots():
    with open("data/brainrots.json", "r") as f:
        return json.load(f)

async def show_shop(msg: types.Message):
    get_user(msg.from_user.id, msg.from_user.username)
    brainrots = load_brainrots()
    text = "üß† –ú–∞–≥–∞–∑–∏–Ω –ë—Ä–µ–π–Ω—Ä–æ—Ç–æ–≤:\n"
    for b in brainrots:
        text += f"{b['name']} ‚Äî {b['price']}‚ÇΩ ({b['rarity']})\n"
    text += "\nüì∏ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω –∏ –æ—Ç–ø—Ä–∞–≤—å –µ–≥–æ ‚Äî –±–µ–∑ –Ω–µ–≥–æ –≤–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–∞–¥—É—Ç."
    await msg.answer(text + "\n–ö—É–ø–∏—Ç—å: /buy –ù–∞–∑–≤–∞–Ω–∏–µ")

async def buy_brainrot(msg: types.Message):
    name = msg.text.replace("/buy ", "")
    brainrots = load_brainrots()
    selected = next((b for b in brainrots if b["name"].lower() == name.lower()), None)
    if not selected:
        await msg.answer("–¢–∞–∫–æ–≥–æ –ë—Ä–µ–π–Ω—Ä–æ—Ç–∞ –Ω–µ—Ç.")
        return

    conn = sqlite3.connect("users.db")
    cur = conn.cursor()
    cur.execute("SELECT balance FROM users WHERE id=?", (msg.from_user.id,))
    balance = cur.fetchone()[0]

    if balance >= selected["price"]:
        cur.execute("UPDATE users SET balance=balance-?, crystals=crystals+? WHERE id=?",
                    (selected["price"], selected["crystal_value"], msg.from_user.id))
        cur.execute("INSERT INTO inventory (user_id, brainrot) VALUES (?, ?)",
                    (msg.from_user.id, selected["name"]))
        conn.commit()
        await msg.answer(
            f"‚úÖ –í—ã –∫—É–ø–∏–ª–∏: {selected['name']}!\n"
            f"üíé –ü–æ–ª—É—á–µ–Ω–æ: {selected['crystal_value']} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤\n\n"
            f"üì© –ù–∞–ø–∏—à–∏ @Nick5239 –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.\n"
            f"üì∏ –ù–µ –∑–∞–±—É–¥—å —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω –æ–ø–ª–∞—Ç—ã ‚Äî –±–µ–∑ –Ω–µ–≥–æ –≤–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–∞–¥—É—Ç."
        )
    else:
        await msg.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.")
    conn.close()
